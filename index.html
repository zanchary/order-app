<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ææ–™è¨‚è³¼å–®</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* --- å…¨åŸŸè¨­å®š --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif; 
      background-color: #eef1f5; 
      margin: 0; padding: 0; 
      padding-bottom: 120px; /* é ç•™åº•éƒ¨æŒ‰éˆ•ç©ºé–“ */
    }

    /* --- 1. é–€ç¥ç•«é¢ (ç™»å…¥æª¢æŸ¥ç”¨) --- */
    #gatekeeper {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: #eef1f5; z-index: 9999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      padding: 20px; text-align: center;
    }
    .gate-msg { font-size: 20px; color: #333; margin-bottom: 30px; font-weight: bold; }
    .gate-btn {
      background: #06c755; color: white; border: none; padding: 18px 50px;
      font-size: 22px; border-radius: 50px; font-weight: bold; cursor: pointer;
      box-shadow: 0 4px 15px rgba(6, 199, 85, 0.4);
      display: none; /* é è¨­éš±è—ï¼Œæª¢æŸ¥åˆ°æ²’ç™»å…¥æ‰é¡¯ç¤º */
    }
    .gate-btn:active { transform: scale(0.95); }

    /* --- 2. ä¸»æ‡‰ç”¨ç¨‹å¼ (è¡¨å–®) --- */
    #app-container { display: none; } /* é©—è­‰é€šéæ‰é¡¯ç¤º */

    /* é ‚éƒ¨æ¨™é¡Œ */
    .header {
      background: white; padding: 15px 15px; border-bottom: 1px solid #ccc;
      position: sticky; top: 0; z-index: 100;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .header h2 { margin: 0; font-size: 24px; color: #000; font-weight: 800; }
    .item-count { background: #06c755; color: white; padding: 5px 12px; border-radius: 20px; font-size: 18px; font-weight: bold; }

    /* åˆ—è¡¨å€ */
    #order-list { padding: 10px; }

    /* å¡ç‰‡æ¨£å¼ */
    .order-card {
      background: white; border-radius: 12px; padding: 15px;
      margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
      position: relative; border: 1px solid #ddd;
    }
    .card-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee;
    }
    .card-title { font-weight: 900; color: #333; font-size: 24px; }
    
    .delete-btn {
      color: white; background-color: #ff3b30; border: none;
      font-size: 16px; padding: 8px 16px; border-radius: 8px;
    }

    /* è¼¸å…¥å€å¡Š (é•·è¼©å‹å–„å¤§å°ºå¯¸) */
    .input-group { margin-bottom: 15px; }
    .input-row { display: flex; gap: 10px; }
    
    label { 
      display: block; font-size: 20px; color: #333; 
      margin-bottom: 5px; font-weight: 700; 
    }
    
    input {
      width: 100%; height: 70px; /* è¶…å¤§é»æ“Šå€ */
      padding: 5px 15px;
      border: 2px solid #ccc; border-radius: 10px;
      font-size: 26px; /* è¶…å¤§å­—é«” */
      background: #f9f9f9; color: #000; font-weight: 500;
    }
    input:focus { 
      border-color: #06c755; background: white; outline: none;
      box-shadow: 0 0 0 3px rgba(6, 199, 85, 0.2); 
    }
    input::placeholder { color: #bbb; font-size: 22px; }

    /* åº•éƒ¨æŒ‰éˆ•å€ */
    .footer-actions {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: white; padding: 15px; border-top: 1px solid #ccc;
      display: flex; gap: 10px; z-index: 200;
      box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
    }
    .btn {
      flex: 1; padding: 15px 0; border: none; border-radius: 10px;
      font-size: 22px; font-weight: 800; cursor: pointer;
      display: flex; justify-content: center; align-items: center;
    }
    .btn-add { background: #e8f5e9; color: #06c755; flex: 0.4; border: 2px solid #06c755; }
    .btn-send { background: #06c755; color: white; flex: 1; }
    .btn:active { opacity: 0.8; }
  </style>
</head>
<body>

  <div id="gatekeeper">
    <div class="gate-msg" id="gate-msg">ç³»çµ±é€£ç·šä¸­...</div>
    <button class="gate-btn" id="login-btn" onclick="startLogin()">LINE ç™»å…¥ / æˆæ¬Š</button>
  </div>

  <div id="app-container">
    <div class="header">
      <h2>ğŸ“ è¨‚è³¼å–®</h2>
      <span class="item-count" id="total-count">1</span>
    </div>

    <div id="order-list">
      </div>

    <div class="footer-actions">
      <button class="btn btn-add" onclick="addItem()">ï¼‹ æ–°å¢</button>
      <button class="btn btn-send" onclick="sendOrder()">ç¢ºèªé€å‡º</button>
    </div>
  </div>

  <script>
    // æ‚¨çš„ GitHub Pages LIFF ID
    const YOUR_LIFF_ID = '2008839956-KquncO8W'; 

    // --- LIFF åˆå§‹åŒ–èˆ‡ç™»å…¥æª¢æŸ¥ ---
    window.onload = function() {
      // é¡¯ç¤ºæª¢æŸ¥ä¸­
      document.getElementById('gate-msg').innerText = "ç³»çµ±æª¢æŸ¥ä¸­...";

      liff.init({ liffId: YOUR_LIFF_ID })
        .then(() => {
          checkLoginStatus();
        })
        .catch((err) => {
          // åˆå§‹åŒ–å¤±æ•— (å¯èƒ½æ˜¯ ID éŒ¯æˆ–ç¶²è·¯å•é¡Œ)
          document.getElementById('gate-msg').innerText = "ç³»çµ±é€£ç·šå¤±æ•—";
          console.error(err);
        });
    };

    function checkLoginStatus() {
      // 1. æª¢æŸ¥æ˜¯å¦ç™»å…¥
      if (!liff.isLoggedIn()) {
        showGateButton("è«‹å…ˆç™»å…¥ LINE");
        return;
      }

      // 2. æª¢æŸ¥æ¬Šé™ (ç¢ºä¿èƒ½ç™¼é€è¨Šæ¯)
      const context = liff.getContext();
      const scopes = (context && context.scope) ? context.scope : [];
      if (!scopes.includes("chat_message.write")) {
        showGateButton("ç¼ºå°‘ç™¼é€æ¬Šé™ï¼Œè«‹é»æ“Šä¿®å¾©");
        return;
      }

      // 3. ä¸€åˆ‡æ­£å¸¸ï¼Œé€²å…¥è¡¨å–®
      enterApp();
    }

    function showGateButton(msg) {
      document.getElementById('gate-msg').innerText = msg;
      document.getElementById('login-btn').style.display = 'block';
    }

    // æŒ‰éˆ•é»æ“Šäº‹ä»¶ï¼šå¼·åˆ¶ç™»å…¥ä¸¦è¦æ±‚æˆæ¬Š
    function startLogin() {
      liff.login({ scope: "profile chat_message.write", prompt: "consent" });
    }

    // é€²å…¥ä¸»ç¨‹å¼
    function enterApp() {
      document.getElementById('gatekeeper').style.display = 'none';
      document.getElementById('app-container').style.display = 'block';
      addItem(); // é è¨­æ–°å¢ä¸€ç­†
    }

    // --- ä»¥ä¸‹æ˜¯åŸæœ¬çš„è¡¨å–®é‚è¼¯ ---

    function addItem() {
      const container = document.getElementById('order-list');
      const count = container.children.length + 1;
      
      const div = document.createElement('div');
      div.className = 'order-card';
      div.innerHTML = `
        <div class="card-header">
          <span class="card-title">é …ç›® #${count}</span>
          ${count > 1 ? '<button class="delete-btn" onclick="removeItem(this)">åˆªé™¤</button>' : ''}
        </div>
        
        <div class="input-group">
          <label>å‹è™Ÿ</label>
          <input type="text" class="input-model" placeholder="å¡«å¯«å‹è™Ÿ">
        </div>

        <div class="input-row">
          <div style="flex: 1;">
            <label>å°ºå¯¸</label>
            <input type="text" class="input-size" placeholder="å¡«å¯«">
          </div>
          <div style="flex: 1;">
            <label>æ•¸é‡</label>
            <input type="number" class="input-qty" inputmode="numeric" placeholder="å¡«å¯«">
          </div>
        </div>
        
        <div class="input-group" style="margin-top: 15px;">
          <label>é¡è‰²</label>
          <input type="text" class="input-color" placeholder="å¡«å¯«é¡è‰² (é¸å¡«)">
        </div>
      `;
      container.appendChild(div);
      updateCount();
      
      // å¹³æ»‘æ²å‹•
      setTimeout(() => {
          div.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 100);
    }

    function removeItem(btn) {
      if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é …ç›®å—ï¼Ÿ')) {
        const card = btn.closest('.order-card');
        card.remove();
        // é‡æ–°ç·¨è™Ÿ
        const cards = document.querySelectorAll('.order-card');
        cards.forEach((card, index) => {
          card.querySelector('.card-title').innerText = `é …ç›® #${index + 1}`;
          const delBtn = card.querySelector('.delete-btn');
          if(index === 0 && delBtn) delBtn.remove();
        });
        updateCount();
      }
    }

    function updateCount() {
      const count = document.querySelectorAll('.order-card').length;
      document.getElementById('total-count').innerText = `${count} ç­†`;
    }

    function sendOrder() {
      const cards = document.querySelectorAll('.order-card');
      let messageLines = [];
      let hasError = false;
      let firstErrorInput = null;

      cards.forEach((card, index) => {
        const modelInput = card.querySelector('.input-model');
        const qtyInput = card.querySelector('.input-qty');
        const model = modelInput.value.trim();
        const size = card.querySelector('.input-size').value.trim();
        const qty = qtyInput.value.trim();
        const color = card.querySelector('.input-color').value.trim();

        // é‡ç½®ç´…æ¡†
        modelInput.style.borderColor = '#ccc';
        qtyInput.style.borderColor = '#ccc';
        modelInput.style.background = '#f9f9f9';
        qtyInput.style.background = '#f9f9f9';

        if (!model || !qty) {
          hasError = true;
          if(!model) {
              modelInput.style.borderColor = 'red';
              modelInput.style.background = '#ffe6e6';
              if(!firstErrorInput) firstErrorInput = modelInput;
          }
          if(!qty) {
              qtyInput.style.borderColor = 'red';
              qtyInput.style.background = '#ffe6e6';
              if(!firstErrorInput) firstErrorInput = qtyInput;
          }
        } else {
          const line = `${model}, ${size || ' '}, ${qty}, ${color || ' '}`;
          messageLines.push(line);
        }
      });

      if (hasError) {
        if(firstErrorInput) firstErrorInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        alert('è«‹å¡«å¯«ç´…è‰²çš„å¿…å¡«æ¬„ä½ï¼');
        return;
      }

      if (messageLines.length === 0) return;

      const finalMessage = messageLines.join('\n');

      if (liff.isInClient()) {
        liff.sendMessages([{ type: 'text', text: finalMessage }])
          .then(() => { liff.closeWindow(); })
          .catch((err) => { 
             alert('ç™¼é€å¤±æ•—ï¼š' + err);
          });
      } else {
        alert("æ¸¬è©¦æ¨¡å¼å…§å®¹ï¼š\n" + finalMessage);
      }
    }
  </script>
</body>
</html>