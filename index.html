<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è¨‚è³¼ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: #1a1a24;
      --bg-card-hover: #22222e;
      --accent: #00d4aa;
      --accent-glow: rgba(0, 212, 170, 0.3);
      --accent-secondary: #00b894;
      --text-primary: #ffffff;
      --text-secondary: #a0a0b0;
      --text-muted: #606070;
      --border: #2a2a3a;
      --danger: #ff4757;
      --warning: #ffa502;
      --success: #00d4aa;
      --gradient-accent: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
      --gradient-card: linear-gradient(145deg, #1a1a24 0%, #15151f 100%);
      --shadow-glow: 0 0 30px rgba(0, 212, 170, 0.15);
      --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.4);
      --radius: 16px;
      --radius-sm: 10px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
    body { font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; padding-bottom: 100px; overflow-x: hidden; }
    body::before { content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(ellipse at 20% 20%, rgba(0, 212, 170, 0.08) 0%, transparent 50%), radial-gradient(ellipse at 80% 80%, rgba(0, 184, 148, 0.05) 0%, transparent 50%); pointer-events: none; z-index: 0; }

    .view-section { display: none; position: relative; z-index: 1; }
    .active-view { display: block; animation: fadeIn 0.3s ease; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    @keyframes spin { to { transform: rotate(360deg); } }

    .header { background: rgba(18, 18, 26, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 16px 20px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
    .header-title { display: flex; align-items: center; gap: 10px; }
    .header-icon { width: 36px; height: 36px; background: var(--gradient-accent); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .header h2 { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
    .header h2 span { color: var(--accent); }
    .btn-nav { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); padding: 10px 16px; border-radius: var(--radius-sm); cursor: pointer; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease; }
    .btn-nav:hover { background: var(--bg-card-hover); border-color: var(--accent); }
    .btn-nav:active { transform: scale(0.97); }

    .content-area { padding: 20px 16px; max-width: 600px; margin: 0 auto; }

    /* è¨»å†Šé é¢ */
    .register-container { min-height: calc(100vh - 100px); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center; }
    .register-icon { width: 120px; height: 120px; background: linear-gradient(135deg, rgba(0, 212, 170, 0.2) 0%, rgba(0, 184, 148, 0.1) 100%); border-radius: 60px; display: flex; align-items: center; justify-content: center; font-size: 56px; margin-bottom: 32px; animation: float 3s ease-in-out infinite; border: 2px solid rgba(0, 212, 170, 0.3); }
    .register-title { font-size: 28px; font-weight: 900; margin-bottom: 12px; background: var(--gradient-accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .register-subtitle { font-size: 16px; color: var(--text-secondary); margin-bottom: 40px; line-height: 1.6; }
    .register-card { background: var(--gradient-card); border-radius: var(--radius); padding: 32px 24px; width: 100%; max-width: 400px; border: 1px solid var(--border); box-shadow: var(--shadow-card); }
    .register-card h3 { font-size: 18px; margin-bottom: 8px; color: var(--text-primary); }
    .register-card p { font-size: 14px; color: var(--text-muted); margin-bottom: 24px; }
    .register-input { width: 100%; height: 56px; padding: 0 20px; border: 2px solid var(--border); border-radius: var(--radius-sm); font-size: 18px; font-weight: 500; background: var(--bg-secondary); color: var(--text-primary); transition: all 0.2s ease; font-family: inherit; margin-bottom: 20px; }
    .register-input::placeholder { color: var(--text-muted); }
    .register-input:focus { border-color: var(--accent); background: var(--bg-primary); outline: none; box-shadow: 0 0 0 4px var(--accent-glow); }
    .register-btn { width: 100%; height: 56px; background: var(--gradient-accent); color: var(--bg-primary); border: none; border-radius: var(--radius-sm); font-size: 18px; font-weight: 700; cursor: pointer; transition: all 0.2s ease; font-family: inherit; }
    .register-btn:hover { transform: scale(1.02); box-shadow: var(--shadow-glow); }
    .register-btn:active { transform: scale(0.98); }
    .register-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .register-features { display: flex; flex-direction: column; gap: 16px; margin-top: 40px; width: 100%; max-width: 400px; }
    .feature-item { display: flex; align-items: center; gap: 16px; background: var(--bg-card); padding: 16px 20px; border-radius: var(--radius-sm); border: 1px solid var(--border); }
    .feature-icon { width: 44px; height: 44px; background: rgba(0, 212, 170, 0.15); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; }
    .feature-text { text-align: left; }
    .feature-text h4 { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
    .feature-text p { font-size: 13px; color: var(--text-muted); }

    /* æ¥­å‹™æ¨¡å¼ */
    .mode-switch { background: var(--bg-card); border-radius: var(--radius); padding: 16px; margin-bottom: 20px; border: 1px solid var(--border); }
    .mode-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .mode-tab { flex: 1; padding: 12px; background: var(--bg-secondary); border: 2px solid transparent; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s ease; text-align: center; }
    .mode-tab.active { background: rgba(0, 212, 170, 0.1); border-color: var(--accent); }
    .mode-tab-icon { font-size: 24px; margin-bottom: 6px; }
    .mode-tab-label { font-size: 13px; font-weight: 600; color: var(--text-secondary); }
    .mode-tab.active .mode-tab-label { color: var(--accent); }
    .agent-selector { display: none; }
    .agent-selector.show { display: block; animation: fadeIn 0.3s ease; }
    .agent-selector label { display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500; }
    .agent-input-group { display: flex; gap: 10px; }
    .agent-select, .agent-input { flex: 1; height: 48px; padding: 0 16px; border: 2px solid var(--border); border-radius: var(--radius-sm); font-size: 15px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit; }
    .agent-select:focus, .agent-input:focus { border-color: var(--accent); outline: none; }
    .agent-input { display: none; }
    .agent-input.show { display: block; }

    /* è¨‚å–®å¡ç‰‡ */
    .order-card { background: var(--gradient-card); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow-card); border: 1px solid var(--border); position: relative; overflow: hidden; animation: slideUp 0.4s ease backwards; }
    .order-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--gradient-accent); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .card-number { display: flex; align-items: center; gap: 10px; }
    .card-badge { background: var(--accent); color: var(--bg-primary); font-size: 12px; font-weight: 700; padding: 4px 10px; border-radius: 20px; }
    .card-label { color: var(--text-secondary); font-size: 14px; }
    .btn-delete-card { background: rgba(255, 71, 87, 0.1); color: var(--danger); border: 1px solid rgba(255, 71, 87, 0.3); padding: 8px 14px; border-radius: var(--radius-sm); cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s ease; }
    .btn-delete-card:hover { background: rgba(255, 71, 87, 0.2); }

    .input-group { margin-bottom: 16px; }
    .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500; letter-spacing: 0.5px; }
    label .required { color: var(--danger); margin-left: 2px; }
    input, textarea { width: 100%; padding: 0 16px; border: 2px solid var(--border); border-radius: var(--radius-sm); font-size: 16px; font-weight: 500; background: var(--bg-secondary); color: var(--text-primary); transition: all 0.2s ease; font-family: inherit; }
    input { height: 52px; }
    textarea { padding: 14px 16px; min-height: 80px; resize: vertical; line-height: 1.5; }
    input::placeholder, textarea::placeholder { color: var(--text-muted); }
    input:focus, textarea:focus { border-color: var(--accent); background: var(--bg-primary); outline: none; box-shadow: 0 0 0 4px var(--accent-glow); }
    input[type="number"] { -moz-appearance: textfield; }
    input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; }

    /* å‚™è¨»å€å¡Š */
    .remark-section { background: var(--bg-card); border-radius: var(--radius); padding: 20px; margin-top: 20px; border: 1px solid var(--border); }
    .remark-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
    .remark-icon { font-size: 20px; }
    .remark-title { font-size: 16px; font-weight: 600; }

    /* åº•éƒ¨æ“ä½œ */
    .footer-actions { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(18, 18, 26, 0.98); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 16px 20px; padding-bottom: calc(16px + env(safe-area-inset-bottom)); border-top: 1px solid var(--border); display: flex; gap: 12px; z-index: 200; }
    .btn { flex: 1; padding: 16px 20px; border: none; border-radius: var(--radius-sm); font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s ease; font-family: inherit; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn:active { transform: scale(0.97); }
    .btn-add { background: var(--bg-card); color: var(--accent); border: 2px solid var(--accent); flex: 0 0 60px; }
    .btn-add:hover { background: rgba(0, 212, 170, 0.1); }
    .btn-send { background: var(--gradient-accent); color: var(--bg-primary); position: relative; overflow: hidden; }
    .btn-send::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: 0.5s; }
    .btn-send:hover::before { left: 100%; }
    .btn-send:disabled { opacity: 0.6; cursor: not-allowed; }

    /* æ­·å²ç´€éŒ„ */
    .history-card { background: var(--gradient-card); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow-card); border: 1px solid var(--border); animation: slideUp 0.4s ease backwards; position: relative; overflow: hidden; }
    .history-card.editable::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--gradient-accent); }
    .history-card.expired::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--danger); }
    .history-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
    .history-meta { display: flex; flex-direction: column; gap: 4px; }
    .history-time { font-size: 14px; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }
    .history-id { font-size: 12px; color: var(--text-muted); font-family: 'SF Mono', 'Fira Code', monospace; }
    .history-status { font-size: 12px; font-weight: 600; padding: 6px 12px; border-radius: 20px; }
    .status-active { background: rgba(0, 212, 170, 0.15); color: var(--accent); }
    .status-expired { background: rgba(255, 71, 87, 0.15); color: var(--danger); }
    .history-content { background: var(--bg-secondary); border-radius: var(--radius-sm); padding: 16px; margin-bottom: 16px; }
    .order-item { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 8px; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
    .order-item:last-child { border-bottom: none; }
    .order-item-label { color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .order-item-value { color: var(--text-primary); font-weight: 500; }
    .history-remark { background: rgba(255, 165, 2, 0.1); border: 1px solid rgba(255, 165, 2, 0.3); border-radius: var(--radius-sm); padding: 12px 16px; margin-bottom: 16px; }
    .history-remark-label { font-size: 12px; color: var(--warning); font-weight: 600; margin-bottom: 6px; }
    .history-remark-text { font-size: 14px; color: var(--text-primary); line-height: 1.5; }
    .history-actions { display: flex; gap: 10px; }
    .btn-action { flex: 1; padding: 12px; border: none; border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .btn-action:active { transform: scale(0.97); }
    .btn-edit { background: rgba(255, 165, 2, 0.15); color: var(--warning); border: 1px solid rgba(255, 165, 2, 0.3); }
    .btn-edit:hover { background: rgba(255, 165, 2, 0.25); }
    .btn-del { background: rgba(255, 71, 87, 0.15); color: var(--danger); border: 1px solid rgba(255, 71, 87, 0.3); }
    .btn-del:hover { background: rgba(255, 71, 87, 0.25); }
    .btn-refresh { width: 100%; margin-top: 20px; padding: 16px; background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-refresh:hover { background: var(--bg-card-hover); border-color: var(--accent); }

    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
    .empty-icon { font-size: 64px; margin-bottom: 20px; opacity: 0.5; }
    .empty-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary); }
    .empty-desc { font-size: 14px; color: var(--text-muted); }

    #loading-mask { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-primary); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 24px; }
    .loader { width: 60px; height: 60px; position: relative; }
    .loader::before, .loader::after { content: ''; position: absolute; border-radius: 50%; }
    .loader::before { width: 100%; height: 100%; border: 3px solid var(--border); }
    .loader::after { width: 100%; height: 100%; border: 3px solid transparent; border-top-color: var(--accent); animation: spin 1s linear infinite; }
    #loading-text { font-size: 16px; color: var(--text-secondary); font-weight: 500; }
    #gate-btn { margin-top: 12px; padding: 14px 40px; background: var(--gradient-accent); color: var(--bg-primary); border: none; border-radius: 30px; font-size: 16px; font-weight: 700; cursor: pointer; display: none; transition: all 0.2s ease; font-family: inherit; }
    #gate-btn:hover { transform: scale(1.05); box-shadow: var(--shadow-glow); }

    .skeleton { background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-card-hover) 50%, var(--bg-card) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: var(--radius-sm); }
    .skeleton-card { background: var(--gradient-card); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; border: 1px solid var(--border); }
    .skeleton-line { height: 16px; margin-bottom: 12px; }
    .skeleton-line.short { width: 60%; }
    .skeleton-box { height: 100px; margin-bottom: 12px; }

    .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%) translateY(-20px); background: var(--bg-card); color: var(--text-primary); padding: 14px 24px; border-radius: var(--radius-sm); border: 1px solid var(--border); box-shadow: var(--shadow-card); z-index: 1000; opacity: 0; transition: all 0.3s ease; display: flex; align-items: center; gap: 10px; font-weight: 500; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast.success { border-color: var(--accent); }
    .toast.error { border-color: var(--danger); }

    .countdown { display: inline-flex; align-items: center; gap: 4px; font-size: 12px; color: var(--warning); font-weight: 600; }
    .countdown-dot { width: 6px; height: 6px; background: var(--warning); border-radius: 50%; animation: pulse 1s infinite; }

    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
    .modal-overlay.show { opacity: 1; visibility: visible; }
    .modal { background: var(--bg-card); border-radius: var(--radius); padding: 28px; margin: 20px; max-width: 360px; width: 100%; border: 1px solid var(--border); transform: scale(0.9); transition: all 0.3s ease; }
    .modal-overlay.show .modal { transform: scale(1); }
    .modal-icon { width: 56px; height: 56px; margin: 0 auto 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; }
    .modal-icon.warning { background: rgba(255, 71, 87, 0.15); }
    .modal-title { font-size: 20px; font-weight: 700; text-align: center; margin-bottom: 12px; }
    .modal-desc { font-size: 14px; color: var(--text-secondary); text-align: center; margin-bottom: 24px; line-height: 1.6; }
    .modal-actions { display: flex; gap: 12px; }
    .modal-btn { flex: 1; padding: 14px; border-radius: var(--radius-sm); font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: none; }
    .modal-btn-cancel { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); }
    .modal-btn-confirm { background: var(--danger); color: white; }

    .order-info-bar { background: rgba(0, 212, 170, 0.1); border: 1px solid rgba(0, 212, 170, 0.3); border-radius: var(--radius-sm); padding: 14px 18px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
    .order-info-icon { font-size: 24px; }
    .order-info-text { flex: 1; }
    .order-info-label { font-size: 12px; color: var(--text-muted); }
    .order-info-value { font-size: 16px; font-weight: 600; color: var(--accent); }
  </style>
</head>
<body>
  <div id="loading-mask">
    <div class="loader"></div>
    <div id="loading-text">ç³»çµ±é€£ç·šä¸­...</div>
    <button id="gate-btn" onclick="liff.login({scope:'profile chat_message.write'})">ç™»å…¥ LINE</button>
  </div>

  <div id="toast" class="toast"></div>

  <div id="modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-icon warning">âš ï¸</div>
      <div class="modal-title" id="modal-title">ç¢ºèªåˆªé™¤</div>
      <div class="modal-desc" id="modal-desc">ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ</div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal()">å–æ¶ˆ</button>
        <button class="modal-btn modal-btn-confirm" id="modal-confirm">ç¢ºèª</button>
      </div>
    </div>
  </div>

  <!-- è¨»å†Šé é¢ -->
  <div id="view-register" class="view-section">
    <div class="register-container">
      <div class="register-icon">ğŸ‘‹</div>
      <h1 class="register-title">æ­¡è¿ä½¿ç”¨è¨‚è³¼ç³»çµ±</h1>
      <p class="register-subtitle">è«‹å…ˆå®Œæˆè¨»å†Šï¼Œè®“æˆ‘å€‘çŸ¥é“æ‚¨ä»£è¡¨å“ªé–“å…¬å¸</p>
      <div class="register-card">
        <h3>å…¬å¸åç¨±</h3>
        <p>è«‹è¼¸å…¥æ‚¨çš„å…¬å¸æˆ–å•†è™Ÿåç¨±</p>
        <input type="text" id="register-company" class="register-input" placeholder="ä¾‹å¦‚ï¼šABC è‚¡ä»½æœ‰é™å…¬å¸">
        <button class="register-btn" onclick="submitRegister()">é–‹å§‹ä½¿ç”¨</button>
      </div>
      <div class="register-features">
        <div class="feature-item"><div class="feature-icon">âš¡</div><div class="feature-text"><h4>å¿«é€Ÿä¸‹å–®</h4><p>ç°¡å–®ä»‹é¢ï¼Œå¿«é€Ÿå®Œæˆè¨‚è³¼</p></div></div>
        <div class="feature-item"><div class="feature-icon">ğŸ“</div><div class="feature-text"><h4>å³æ™‚ä¿®æ”¹</h4><p>ä¸‹å–®å¾Œ 3 åˆ†é˜å…§å¯ä¿®æ”¹æˆ–å–æ¶ˆ</p></div></div>
        <div class="feature-item"><div class="feature-icon">ğŸ“‹</div><div class="feature-text"><h4>è¨‚å–®ç´€éŒ„</h4><p>éš¨æ™‚æŸ¥çœ‹å¾…è™•ç†è¨‚å–®ç‹€æ…‹</p></div></div>
      </div>
    </div>
  </div>

  <!-- ä¸‹å–®é é¢ -->
  <div id="view-form" class="view-section">
    <div class="header">
      <div class="header-title"><div class="header-icon">ğŸ“</div><h2 id="form-title"><span>æ–°å¢</span>è¨‚å–®</h2></div>
      <button class="btn-nav" onclick="showHistoryView()"><span>ğŸ“‹</span> æŸ¥çœ‹ç´€éŒ„</button>
    </div>
    <div class="content-area">
      <div class="order-info-bar" id="order-info-bar">
        <div class="order-info-icon">ğŸ¢</div>
        <div class="order-info-text"><div class="order-info-label">ä¸‹å–®å…¬å¸</div><div class="order-info-value" id="current-company">-</div></div>
      </div>
      <div class="mode-switch" id="mode-switch" style="display:none;">
        <div class="mode-tabs">
          <div class="mode-tab active" data-mode="self" onclick="switchMode('self')"><div class="mode-tab-icon">ğŸ‘¤</div><div class="mode-tab-label">è‡ªå·±ä¸‹å–®</div></div>
          <div class="mode-tab" data-mode="agent" onclick="switchMode('agent')"><div class="mode-tab-icon">ğŸ¤</div><div class="mode-tab-label">ä»£å®¢ä¸‹å–®</div></div>
        </div>
        <div class="agent-selector" id="agent-selector">
          <label>é¸æ“‡å®¢æˆ¶å…¬å¸</label>
          <div class="agent-input-group">
            <select class="agent-select" id="agent-select" onchange="onAgentSelectChange()"><option value="">-- é¸æ“‡å®¢æˆ¶ --</option><option value="__new__">â• è¼¸å…¥æ–°å®¢æˆ¶</option></select>
            <input type="text" class="agent-input" id="agent-input" placeholder="è¼¸å…¥å…¬å¸åç¨±">
          </div>
        </div>
      </div>
      <div id="order-list"></div>
      <div class="remark-section">
        <div class="remark-header"><span class="remark-icon">ğŸ“</span><span class="remark-title">è¨‚å–®å‚™è¨»</span></div>
        <textarea id="order-remark" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚è«‹åœ¨æ­¤èªªæ˜ï¼Œä¾‹å¦‚ï¼šæ€¥ä»¶è«‹å„ªå…ˆè™•ç†ã€æŒ‡å®šé…é€æ™‚é–“ç­‰..."></textarea>
      </div>
    </div>
    <div class="footer-actions">
      <button class="btn btn-add" onclick="addItem()">ï¼‹</button>
      <button class="btn btn-send" onclick="submitOrder()"><span>âœ“</span> ç¢ºèªé€å‡º</button>
    </div>
  </div>

  <!-- æ­·å²ç´€éŒ„ -->
  <div id="view-history" class="view-section">
    <div class="header">
      <div class="header-title"><div class="header-icon">ğŸ“‹</div><h2><span>å¾…è™•ç†</span>è¨‚å–®</h2></div>
      <button class="btn-nav" onclick="showFormView()"><span>â•</span> æˆ‘è¦ä¸‹å–®</button>
    </div>
    <div class="content-area">
      <div id="history-container"></div>
      <button class="btn-refresh" onclick="fetchHistory()"><span>ğŸ”„</span> é‡æ–°æ•´ç†</button>
    </div>
  </div>

  <script>
    const LIFF_ID = '2008839956-KquncO8W';
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwvZ2fedvCCuwHOmucvExPqhxcxPNUzylKu15grJU5BVZIE_8WMAbvc7qcu0r-cbNie/exec';

    let currentOrderId = null, pendingDeleteId = null, countdownIntervals = {}, userInfo = null, customerList = [], currentMode = 'self';

    window.onload = function() {
      liff.init({ liffId: LIFF_ID }).then(() => {
        if (!liff.isLoggedIn()) {
          document.getElementById('loading-text').innerText = "è«‹å…ˆç™»å…¥ LINE";
          document.getElementById('gate-btn').style.display = 'block';
        } else { initApp(); }
      }).catch(err => showToast("åˆå§‹åŒ–å¤±æ•—: " + err, 'error'));
    };

    function initApp() {
      const context = liff.getContext();
      if (!context || !context.userId) { showToast("ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Š", 'error'); return; }
      callApi({ action: 'getUserInfo', userId: context.userId }, (resp) => {
        document.getElementById('loading-mask').style.display = 'none';
        if (resp.result === 'success') {
          userInfo = resp.user;
          customerList = resp.customers || [];
          if (!userInfo.isRegistered) { showRegisterView(); }
          else {
            document.getElementById('current-company').innerText = userInfo.companyName;
            if (userInfo.isSales) { document.getElementById('mode-switch').style.display = 'block'; populateCustomerList(); }
            checkRoute();
          }
        } else { showRegisterView(); }
      });
    }

    function checkRoute() {
      const params = new URLSearchParams(window.location.search);
      if (params.get('page') === 'history') showHistoryView(); else showFormView();
    }

    function hideAllViews() { document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active-view')); }
    function showRegisterView() { hideAllViews(); document.getElementById('view-register').classList.add('active-view'); }
    function showFormView() {
      hideAllViews();
      document.getElementById('view-form').classList.add('active-view');
      if(document.getElementById('order-list').innerHTML === '') addItem();
      document.getElementById('form-title').innerHTML = currentOrderId ? '<span>ä¿®æ”¹</span>è¨‚å–®' : '<span>æ–°å¢</span>è¨‚å–®';
    }
    function showHistoryView() { hideAllViews(); document.getElementById('view-history').classList.add('active-view'); fetchHistory(); }

    function submitRegister() {
      const companyName = document.getElementById('register-company').value.trim();
      if (!companyName) { showToast("è«‹è¼¸å…¥å…¬å¸åç¨±", 'error'); return; }
      const context = liff.getContext();
      if (!context || !context.userId) { showToast("ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Š", 'error'); return; }
      callApi({ action: 'register', userId: context.userId, companyName: companyName }, (resp) => {
        if (resp.result === 'success') {
          showToast("è¨»å†ŠæˆåŠŸï¼æ­¡è¿ä½¿ç”¨", 'success');
          userInfo = { companyName: companyName, isRegistered: true, isSales: false };
          document.getElementById('current-company').innerText = companyName;
          showFormView();
        } else { showToast("è¨»å†Šå¤±æ•—: " + resp.msg, 'error'); }
      });
    }

    function switchMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.mode === mode));
      const agentSelector = document.getElementById('agent-selector'), orderInfoBar = document.getElementById('order-info-bar');
      if (mode === 'agent') { agentSelector.classList.add('show'); updateOrderInfoBar(); }
      else { agentSelector.classList.remove('show'); document.getElementById('current-company').innerText = userInfo.companyName; orderInfoBar.style.background = 'rgba(0, 212, 170, 0.1)'; orderInfoBar.style.borderColor = 'rgba(0, 212, 170, 0.3)'; }
    }

    function populateCustomerList() {
      const select = document.getElementById('agent-select');
      select.innerHTML = '<option value="">-- é¸æ“‡å®¢æˆ¶ --</option><option value="__new__">â• è¼¸å…¥æ–°å®¢æˆ¶</option>';
      customerList.forEach(c => { const opt = document.createElement('option'); opt.value = c.name; opt.textContent = c.name; select.appendChild(opt); });
    }

    function onAgentSelectChange() {
      const select = document.getElementById('agent-select'), input = document.getElementById('agent-input');
      if (select.value === '__new__') { input.classList.add('show'); input.focus(); } else { input.classList.remove('show'); input.value = ''; }
      updateOrderInfoBar();
    }

    function updateOrderInfoBar() {
      const select = document.getElementById('agent-select'), input = document.getElementById('agent-input'), orderInfoBar = document.getElementById('order-info-bar'), companyDisplay = document.getElementById('current-company');
      let companyName = select.value === '__new__' ? (input.value.trim() || 'è«‹è¼¸å…¥å®¢æˆ¶åç¨±') : (select.value || 'è«‹é¸æ“‡å®¢æˆ¶');
      companyDisplay.innerText = companyName;
      orderInfoBar.style.background = 'rgba(255, 165, 2, 0.1)'; orderInfoBar.style.borderColor = 'rgba(255, 165, 2, 0.3)';
    }

    document.getElementById('agent-input')?.addEventListener('input', updateOrderInfoBar);

    function callApi(data, callback) {
      showLoading("è™•ç†ä¸­...");
      fetch(GAS_URL, { method: 'POST', body: JSON.stringify(data) }).then(res => res.json()).then(json => { hideLoading(); callback(json); }).catch(err => { hideLoading(); showToast("é€£ç·šéŒ¯èª¤: " + err, 'error'); });
    }

    function showLoading(text) { document.getElementById('loading-text').innerText = text || "è™•ç†ä¸­..."; document.getElementById('gate-btn').style.display = 'none'; document.getElementById('loading-mask').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loading-mask').style.display = 'none'; }
    function showToast(msg, type = 'success') { const t = document.getElementById('toast'); t.innerHTML = `<span>${type === 'success' ? 'âœ“' : 'âœ•'}</span> ${msg}`; t.className = `toast ${type} show`; setTimeout(() => t.classList.remove('show'), 3000); }
    function showModal(title, desc, onConfirm) { document.getElementById('modal-title').innerText = title; document.getElementById('modal-desc').innerText = desc; document.getElementById('modal-confirm').onclick = onConfirm; document.getElementById('modal').classList.add('show'); }
    function hideModal() { document.getElementById('modal').classList.remove('show'); }

    function fetchHistory() {
      const context = liff.getContext(); if (!context || !context.userId) return;
      const container = document.getElementById('history-container');
      container.innerHTML = '<div class="skeleton-card"><div class="skeleton skeleton-line short"></div><div class="skeleton skeleton-box"></div></div>';
      Object.keys(countdownIntervals).forEach(key => clearInterval(countdownIntervals[key])); countdownIntervals = {};
      callApi({ action: 'getOrders', userId: context.userId }, (resp) => {
        container.innerHTML = '';
        if (!resp.orders || resp.orders.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“¦</div><div class="empty-title">ç›®å‰æ²’æœ‰å¾…è™•ç†è¨‚å–®</div><div class="empty-desc">é»æ“Šã€Œæˆ‘è¦ä¸‹å–®ã€é–‹å§‹å»ºç«‹æ–°è¨‚å–®</div></div>'; return; }
        resp.orders.forEach((order, index) => {
          const div = document.createElement('div'), isEditable = order.remaining > 0;
          div.className = `history-card ${isEditable ? 'editable' : 'expired'}`; div.style.animationDelay = `${index * 0.1}s`;
          const items = parseOrderContent(order.content);
          let itemsHtml = items.map(item => `<div class="order-item"><div><div class="order-item-label">å‹è™Ÿ</div><div class="order-item-value">${escapeHtml(item.model)}</div></div><div><div class="order-item-label">å°ºå¯¸</div><div class="order-item-value">${escapeHtml(item.size) || '-'}</div></div><div><div class="order-item-label">æ•¸é‡</div><div class="order-item-value">${escapeHtml(item.qty)}</div></div><div><div class="order-item-label">é¡è‰²</div><div class="order-item-value">${escapeHtml(item.color) || '-'}</div></div></div>`).join('');
          let remarkHtml = order.remark ? `<div class="history-remark"><div class="history-remark-label">ğŸ“ å‚™è¨»</div><div class="history-remark-text">${escapeHtml(order.remark)}</div></div>` : '';
          let statusHtml = isEditable ? `<div class="history-status status-active"><span class="countdown" id="countdown-${order.orderId}"><span class="countdown-dot"></span> å‰©é¤˜ ${formatTime(order.remaining)}</span></div>` : `<div class="history-status status-expired">å·²é€¾æ™‚</div>`;
          let actionsHtml = isEditable ? `<div class="history-actions"><button class="btn-action btn-edit" onclick="loadEdit('${order.orderId}', '${encodeURIComponent(order.content)}', '${encodeURIComponent(order.remark || '')}')">âœï¸ ä¿®æ”¹</button><button class="btn-action btn-del" onclick="confirmDelete('${order.orderId}')">ğŸ—‘ï¸ åˆªé™¤</button></div>` : `<div style="text-align:center; color:var(--text-muted); font-size:13px; padding:10px;">å·²è¶…éä¿®æ”¹æ™‚é™</div>`;
          if (isEditable) startCountdown(order.orderId, order.remaining);
          div.innerHTML = `<div class="history-header"><div class="history-meta"><div class="history-time">ğŸ“… ${order.time}</div><div class="history-id">${order.orderId}</div></div>${statusHtml}</div><div class="history-content">${itemsHtml}</div>${remarkHtml}${actionsHtml}`;
          container.appendChild(div);
        });
      });
    }

    function startCountdown(orderId, seconds) {
      let remaining = seconds;
      countdownIntervals[orderId] = setInterval(() => {
        remaining--;
        const el = document.getElementById(`countdown-${orderId}`);
        if (remaining <= 0) { clearInterval(countdownIntervals[orderId]); if (el) { el.parentElement.className = 'history-status status-expired'; el.parentElement.innerHTML = 'å·²é€¾æ™‚'; } return; }
        if (el) el.innerHTML = `<span class="countdown-dot"></span> å‰©é¤˜ ${formatTime(remaining)}`;
      }, 1000);
    }

    function formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }

    function loadEdit(orderId, contentEncoded, remarkEncoded) {
      currentOrderId = orderId;
      showFormView();
      document.getElementById('order-list').innerHTML = '';
      decodeURIComponent(contentEncoded).split('\n').forEach(line => { const p = line.split(','); if(p.length >= 3) addItem(p[0].trim(), p[1].trim(), p[2].trim(), p[3] ? p[3].trim() : ''); });
      document.getElementById('order-remark').value = decodeURIComponent(remarkEncoded);
    }

    function confirmDelete(orderId) { pendingDeleteId = orderId; showModal('ç¢ºèªåˆªé™¤è¨‚å–®', 'åˆªé™¤å¾Œå°‡ç„¡æ³•æ¢å¾©ï¼Œç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ', executeDelete); }
    function executeDelete() { hideModal(); if (!pendingDeleteId) return; const context = liff.getContext(); if (!context || !context.userId) { showToast("ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Š", 'error'); return; } callApi({ action: 'delete', orderId: pendingDeleteId, userId: context.userId }, (resp) => { if(resp.result === 'success') { showToast("è¨‚å–®å·²åˆªé™¤", 'success'); fetchHistory(); } else { showToast("åˆªé™¤å¤±æ•—: " + resp.msg, 'error'); } pendingDeleteId = null; }); }

    function submitOrder() {
      const cards = document.querySelectorAll('.card-item'); let lines = [];
      cards.forEach(card => { const m = card.querySelector('.in-model').value.trim(), s = card.querySelector('.in-size').value.trim(), q = card.querySelector('.in-qty').value.trim(), c = card.querySelector('.in-color').value.trim(); if(m && q) lines.push(`${m}, ${s}, ${q}, ${c}`); });
      if(lines.length === 0) { showToast("è«‹å¡«å¯«ã€Œå‹è™Ÿã€èˆ‡ã€Œæ•¸é‡ã€", 'error'); return; }
      let orderCompany = userInfo.companyName;
      if (currentMode === 'agent') { const sel = document.getElementById('agent-select'), inp = document.getElementById('agent-input'); orderCompany = sel.value === '__new__' ? inp.value.trim() : sel.value; if (!orderCompany) { showToast("è«‹é¸æ“‡æˆ–è¼¸å…¥å®¢æˆ¶å…¬å¸", 'error'); return; } }
      const remark = document.getElementById('order-remark').value.trim(), action = currentOrderId ? 'update' : 'create', context = liff.getContext();
      if (!context || !context.userId) { showToast("ç„¡æ³•å–å¾—ä½¿ç”¨è€… ID", 'error'); return; }
      callApi({ action: action, orderId: currentOrderId, userId: context.userId, companyName: orderCompany, content: lines.join('\n'), remark: remark, isAgentOrder: currentMode === 'agent', agentName: currentMode === 'agent' ? userInfo.companyName : null }, (resp) => {
        if(resp.result === 'success') { showToast(action === 'create' ? "è¨‚å–®å·²é€å‡ºï¼" : "ä¿®æ”¹æˆåŠŸï¼", 'success'); currentOrderId = null; document.getElementById('order-list').innerHTML = ''; document.getElementById('order-remark').value = ''; addItem(); showHistoryView(); }
        else { showToast("æ“ä½œå¤±æ•—: " + resp.msg, 'error'); }
      });
    }

    function addItem(m='', s='', q='', c='') {
      const container = document.getElementById('order-list'), count = container.children.length + 1, div = document.createElement('div');
      div.className = 'order-card card-item'; div.style.animationDelay = `${(count - 1) * 0.1}s`;
      div.innerHTML = `<div class="card-header"><div class="card-number"><span class="card-badge">${count}</span><span class="card-label">å•†å“é …ç›®</span></div>${count > 1 ? '<button class="btn-delete-card" onclick="removeCard(this)">ç§»é™¤</button>' : ''}</div><div class="input-group"><label>å‹è™Ÿ <span class="required">*</span></label><input type="text" class="in-model" value="${escapeHtml(m)}" placeholder="è¼¸å…¥ç”¢å“å‹è™Ÿ"></div><div class="input-row"><div class="input-group"><label>å°ºå¯¸</label><input type="text" class="in-size" value="${escapeHtml(s)}" placeholder="å°ºå¯¸"></div><div class="input-group"><label>æ•¸é‡ <span class="required">*</span></label><input type="number" class="in-qty" value="${escapeHtml(q)}" placeholder="æ•¸é‡" min="1"></div></div><div class="input-group"><label>é¡è‰²</label><input type="text" class="in-color" value="${escapeHtml(c)}" placeholder="é¡è‰²ï¼ˆé¸å¡«ï¼‰"></div>`;
      container.appendChild(div);
      setTimeout(() => { div.scrollIntoView({ behavior: 'smooth', block: 'center' }); div.querySelector('.in-model').focus(); }, 100);
    }

    function removeCard(btn) { const card = btn.closest('.card-item'); card.style.animation = 'fadeIn 0.3s ease reverse'; setTimeout(() => { card.remove(); updateCardNumbers(); }, 300); }
    function updateCardNumbers() { document.querySelectorAll('.card-item').forEach((card, i) => { const badge = card.querySelector('.card-badge'); if (badge) badge.innerText = i + 1; const header = card.querySelector('.card-header'), btn = header.querySelector('.btn-delete-card'); if (i === 0 && btn) btn.remove(); else if (i > 0 && !btn) { const b = document.createElement('button'); b.className = 'btn-delete-card'; b.onclick = function() { removeCard(this); }; b.innerText = 'ç§»é™¤'; header.appendChild(b); } }); }
    function parseOrderContent(content) { return content.split('\n').map(line => { const p = line.split(','); return { model: p[0]?.trim() || '', size: p[1]?.trim() || '', qty: p[2]?.trim() || '', color: p[3]?.trim() || '' }; }).filter(item => item.model); }
    function escapeHtml(str) { if (!str) return ''; return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;'); }
  </script>
</body>
</html>