<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è¨‚è³¼ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* --- CSS æ¨£å¼å€ --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Roboto, sans-serif; background-color: #eef1f5; margin: 0; padding: 0; padding-bottom: 100px; }
    
    /* é é¢åˆ‡æ›æ§åˆ¶ */
    .view-section { display: none; } /* é è¨­å…¨éƒ¨éš±è— */
    .active-view { display: block; }

    /* Header */
    .header { background: white; padding: 15px; border-bottom: 1px solid #ccc; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .header h2 { margin: 0; font-size: 22px; color: #333; font-weight: 800; }
    .btn-home { background: #6c757d; color: white; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 14px;}

    /* åˆ—è¡¨æ¨£å¼ */
    .order-card { background: white; border-radius: 12px; padding: 15px; margin: 15px 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 1px solid #ddd; position: relative; }
    .input-group { margin-bottom: 10px; }
    label { display: block; font-size: 18px; color: #555; margin-bottom: 5px; font-weight: bold; }
    input { width: 100%; height: 50px; padding: 5px 10px; border: 2px solid #ccc; border-radius: 8px; font-size: 20px; background: #f9f9f9; }
    input:focus { border-color: #06c755; background: white; outline: none; }
    
    /* æŒ‰éˆ• */
    .footer-actions { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; border-top: 1px solid #ccc; display: flex; gap: 10px; z-index: 200; }
    .btn { flex: 1; padding: 12px 0; border: none; border-radius: 8px; font-size: 20px; font-weight: 800; cursor: pointer; color: white; }
    .btn-add { background: #e8f5e9; color: #06c755; border: 2px solid #06c755; flex: 0.4; }
    .btn-send { background: #06c755; }
    
    /* æ­·å²è¨‚å–®åˆ—è¡¨å°ˆç”¨ */
    .history-item { border-left: 5px solid #06c755; padding-left: 10px; margin-bottom: 10px; }
    .history-info { font-size: 14px; color: #666; display: flex; justify-content: space-between; margin-bottom: 5px;}
    .history-content { font-size: 18px; font-weight: bold; color: #333; white-space: pre-wrap; margin-bottom: 10px; }
    .history-actions { display: flex; gap: 10px; }
    .btn-small { flex: 1; padding: 8px; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 16px; }
    .btn-edit { background: #ffc107; color: #000; }
    .btn-del { background: #dc3545; }
    .btn-refresh { background: #17a2b8; width: 100%; margin-top: 20px; padding: 10px; color: white; border: none; border-radius: 5px; font-size: 18px;}

    /* è¼‰å…¥é®ç½© */
    #loading-mask { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 20px; flex-direction: column; }
    #gate-btn { margin-top: 20px; padding: 10px 30px; background: #06c755; color: white; border: none; border-radius: 20px; font-size: 18px; display: none;}
  </style>
</head>
<body>

  <div id="loading-mask">
    <div id="loading-text">ç³»çµ±é€£ç·šä¸­...</div>
    <button id="gate-btn" onclick="liff.login({scope:'profile chat_message.write'})">ç™»å…¥ LINE</button>
  </div>

  <div id="view-form" class="view-section">
    <div class="header">
      <h2 id="form-title">ğŸ“ æ–°å¢è¨‚å–®</h2>
      <button class="btn-home" onclick="showHistoryView()">æŸ¥çœ‹ç´€éŒ„</button>
    </div>
    <div id="order-list"></div> <div class="footer-actions">
      <button class="btn btn-add" onclick="addItem()">ï¼‹</button>
      <button class="btn btn-send" onclick="submitOrder()">ç¢ºèªé€å‡º</button>
    </div>
  </div>

  <div id="view-history" class="view-section">
    <div class="header">
      <h2>ğŸ“‹ æœªå‡ºè²¨è¨‚å–®</h2>
      <button class="btn-home" onclick="showFormView()">æˆ‘è¦ä¸‹å–®</button>
    </div>
    <div style="padding: 15px;">
      <div id="history-container">è¼‰å…¥ä¸­...</div>
      <button class="btn-refresh" onclick="fetchHistory()">ğŸ”„ é‡æ–°æ•´ç†</button>
    </div>
  </div>

  <script>
    // âš ï¸ è«‹å¡«å…¥æ‚¨çš„è³‡è¨Š
    const LIFF_ID = '2008839956-KquncO8W'; 
    // âš ï¸ å‹™å¿…æ›æˆæ‚¨ã€Œæ–°éƒ¨ç½²ã€çš„ GAS ç¶²å€
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxSxQMULkJwhjldW0eMWUbesEjxy3Kg0rYQpG7RJufIhzQMtvA9ZlenyEbaQBFkgW52mw/exec';

    let currentOrderId = null; // ç”¨ä¾†åˆ¤æ–·æ˜¯æ–°å¢é‚„æ˜¯ä¿®æ”¹

    window.onload = function() {
      liff.init({ liffId: LIFF_ID }).then(() => {
        if (!liff.isLoggedIn()) {
          document.getElementById('loading-text').innerText = "è«‹å…ˆç™»å…¥";
          document.getElementById('gate-btn').style.display = 'block';
        } else {
          checkRoute(); // ç™»å…¥æˆåŠŸå¾Œï¼Œæª¢æŸ¥ç¶²å€æ±ºå®šå»å“ªä¸€é 
        }
      }).catch(err => alert("åˆå§‹åŒ–å¤±æ•—: " + err));
    };

    // è·¯ç”±æª¢æŸ¥ (åˆæ¬¡è¼‰å…¥æ™‚ç”¨)
    function checkRoute() {
      const params = new URLSearchParams(window.location.search);
      const page = params.get('page');

      document.getElementById('loading-mask').style.display = 'none';

      if (page === 'history') {
        showHistoryView();
      } else {
        showFormView(); // é è¨­é¡¯ç¤ºæ–°å¢è¡¨å–®
      }
    }

    // --- è¦–åœ–åˆ‡æ› (ç„¡åˆ·æ–°åˆ‡æ›) ---
    function showFormView() {
      document.getElementById('view-form').classList.add('active-view');
      document.getElementById('view-history').classList.remove('active-view');
      // å¦‚æœåˆ—è¡¨æ˜¯ç©ºçš„ï¼Œé è¨­åŠ ä¸€ç­†
      if(document.getElementById('order-list').innerHTML === '') addItem();
      // åˆ‡æ›æ¨™é¡Œ
      if(currentOrderId) {
        document.getElementById('form-title').innerText = "âœï¸ ä¿®æ”¹è¨‚å–®";
      } else {
        document.getElementById('form-title').innerText = "ğŸ“ æ–°å¢è¨‚å–®";
      }
    }

    function showHistoryView() {
      document.getElementById('view-form').classList.remove('active-view');
      document.getElementById('view-history').classList.add('active-view');
      fetchHistory(); // è¼‰å…¥è³‡æ–™
    }

    // --- API å‘¼å« ---
    function callApi(data, callback) {
      document.getElementById('loading-mask').style.display = 'flex';
      document.getElementById('loading-text').innerText = "è™•ç†ä¸­...";
      
      fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(json => {
        document.getElementById('loading-mask').style.display = 'none';
        callback(json);
      })
      .catch(err => {
        document.getElementById('loading-mask').style.display = 'none';
        alert("é€£ç·šéŒ¯èª¤: " + err);
      });
    }

    // --- åŠŸèƒ½ 1: å–å¾—æ­·å²è¨‚å–® ---
    function fetchHistory() {
      const context = liff.getContext();
      if (!context || !context.userId) {
         // å¦‚æœæŠ“ä¸åˆ° IDï¼Œå®‰éœåœ°é‡è©¦æˆ–å¿½ç•¥
         return; 
      }
      const userId = context.userId;

      document.getElementById('history-container').innerHTML = 'è¼‰å…¥ä¸­...';

      callApi({ action: 'getOrders', userId: userId }, (resp) => {
        const container = document.getElementById('history-container');
        container.innerHTML = '';

        if (!resp.orders || resp.orders.length === 0) {
          container.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">ç›®å‰æ²’æœ‰å¾…è™•ç†çš„è¨‚å–®</p>';
          return;
        }

        resp.orders.forEach(order => {
          const div = document.createElement('div');
          div.className = 'order-card history-item';
          
          // åˆ¤æ–·æ˜¯å¦å¯ç·¨è¼¯ (3åˆ†é˜å…§)
          let actionHtml = '';
          if (order.remaining > 0) {
            actionHtml = `
              <div class="history-actions">
                <button class="btn-small btn-edit" onclick="loadEdit('${order.orderId}', '${encodeURIComponent(order.content)}')">âœï¸ ä¿®æ”¹ (${order.remaining}s)</button>
                <button class="btn-small btn-del" onclick="deleteOrder('${order.orderId}')">ğŸ—‘ï¸ åˆªé™¤</button>
              </div>`;
          } else {
            actionHtml = `<div style="color:red; font-size:14px; text-align:center; background:#fee; padding:5px; border-radius:5px;">å·²è¶…éä¿®æ”¹æ™‚é™</div>`;
          }

          div.innerHTML = `
            <div class="history-info"><span>ğŸ“… ${order.time}</span><span>${order.orderId}</span></div>
            <div class="history-content">${order.content.replace(/\n/g, '<br>')}</div>
            ${actionHtml}
          `;
          container.appendChild(div);
        });
      });
    }

    // --- åŠŸèƒ½ 2: è¼‰å…¥ä¿®æ”¹ ---
    function loadEdit(orderId, contentEncoded) {
      currentOrderId = orderId;
      const content = decodeURIComponent(contentEncoded);
      
      // åˆ‡æ›å›è¡¨å–®é é¢
      showFormView();
      
      // æ¸…ç©ºè¡¨å–®ä¸¦è§£æå…§å®¹å¡«å…¥
      const container = document.getElementById('order-list');
      container.innerHTML = ''; 
      
      const lines = content.split('\n');
      lines.forEach(line => {
        const parts = line.split(',');
        if(parts.length >= 3) {
           addItem(parts[0].trim(), parts[1].trim(), parts[2].trim(), parts[3] ? parts[3].trim() : '');
        }
      });
    }

    // --- åŠŸèƒ½ 3: åˆªé™¤è¨‚å–® ---
    function deleteOrder(orderId) {
      if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ")) return;
      callApi({ action: 'delete', orderId: orderId }, (resp) => {
        if(resp.result === 'success') {
          alert("åˆªé™¤æˆåŠŸ");
          fetchHistory(); // é‡æ–°æ•´ç†åˆ—è¡¨
        } else {
          alert("å¤±æ•—: " + resp.msg);
        }
      });
    }

    // --- åŠŸèƒ½ 4: é€å‡º (æ–°å¢æˆ–ä¿®æ”¹) ---
    function submitOrder() {
      const cards = document.querySelectorAll('.card-item'); 
      let lines = [];
      
      // 1. æŠ“å–è¡¨å–®è³‡æ–™
      cards.forEach(card => {
        const m = card.querySelector('.in-model').value.trim();
        const s = card.querySelector('.in-size').value.trim();
        const q = card.querySelector('.in-qty').value.trim();
        const c = card.querySelector('.in-color').value.trim();
        
        if(m && q) lines.push(`${m}, ${s}, ${q}, ${c}`);
      });

      if(lines.length === 0) return alert("è«‹å¡«å¯«ã€Œå‹è™Ÿã€èˆ‡ã€Œæ•¸é‡ã€ï¼");

      const action = currentOrderId ? 'update' : 'create';
      
      // å–å¾— ID
      const context = liff.getContext();
      if (!context || !context.userId) {
        alert("ç„¡æ³•å–å¾—ä½¿ç”¨è€… IDï¼Œè«‹é‡æ–°ç™»å…¥");
        location.reload();
        return;
      }
      const userId = context.userId;

      // 3. å‘¼å« GAS API
      callApi({
        action: action,
        orderId: currentOrderId,
        userId: userId,
        content: lines.join('\n')
      }, (resp) => {
        if(resp.result === 'success') {
          alert(action === 'create' ? "è¨‚å–®å·²é€å‡ºï¼" : "ä¿®æ”¹æˆåŠŸï¼");
          
          // ä¿®æ­£é» 3ï¼šæˆåŠŸå¾Œç›´æ¥åˆ‡æ›è¦–åœ–ï¼Œä¸é‡æ–°å°å‘
          currentOrderId = null; // é‡ç½®ç‹€æ…‹
          showHistoryView(); 
          
        } else {
          alert("å¤±æ•—: " + resp.msg);
        }
      });
    }

    // --- è¼”åŠ©: å‹•æ…‹æ–°å¢å¡ç‰‡ ---
    function addItem(m='', s='', q='', c='') {
      const container = document.getElementById('order-list');
      const count = container.children.length + 1;
      const div = document.createElement('div');
      div.className = 'order-card card-item';
      div.innerHTML = `
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <b style="font-size:18px;">é …ç›® #${count}</b>
          ${count > 1 ? '<button style="background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:5px;" onclick="this.parentElement.parentElement.remove()">åˆªé™¤</button>' : ''}
        </div>
        <div class="input-group"><label>å‹è™Ÿ</label><input type="text" class="in-model" value="${m}" placeholder="å‹è™Ÿ"></div>
        <div style="display:flex; gap:10px;">
          <div style="flex:1;"><label>å°ºå¯¸</label><input type="text" class="in-size" value="${s}"></div>
          <div style="flex:1;"><label>æ•¸é‡</label><input type="number" class="in-qty" value="${q}"></div>
        </div>
        <div class="input-group" style="margin-top:10px;"><label>é¡è‰²</label><input type="text" class="in-color" value="${c}"></div>
      `;
      container.appendChild(div);
      setTimeout(() => div.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
    }
  </script>
</body>
</html>