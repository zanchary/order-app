<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è¨‚è³¼ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: #1a1a24;
      --bg-card-hover: #22222e;
      --accent: #00d4aa;
      --accent-glow: rgba(0, 212, 170, 0.3);
      --accent-secondary: #00b894;
      --text-primary: #ffffff;
      --text-secondary: #a0a0b0;
      --text-muted: #606070;
      --border: #2a2a3a;
      --danger: #ff4757;
      --warning: #ffa502;
      --success: #00d4aa;
      --gradient-accent: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
      --gradient-card: linear-gradient(145deg, #1a1a24 0%, #15151f 100%);
      --shadow-glow: 0 0 30px rgba(0, 212, 170, 0.15);
      --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.4);
      --radius: 16px;
      --radius-sm: 10px;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding-bottom: 100px;
      overflow-x: hidden;
    }

    /* èƒŒæ™¯è£é£¾ */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(ellipse at 20% 20%, rgba(0, 212, 170, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(0, 184, 148, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .view-section { 
      display: none;
      position: relative;
      z-index: 1;
    }
    .active-view { 
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(0, 212, 170, 0.2); }
      50% { box-shadow: 0 0 30px rgba(0, 212, 170, 0.4); }
    }

    /* Header */
    .header {
      background: rgba(18, 18, 26, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-icon {
      width: 36px;
      height: 36px;
      background: var(--gradient-accent);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .header h2 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .header h2 span {
      color: var(--accent);
    }

    .btn-nav {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
    }

    .btn-nav:hover {
      background: var(--bg-card-hover);
      border-color: var(--accent);
    }

    .btn-nav:active {
      transform: scale(0.97);
    }

    /* å…§å®¹å€åŸŸ */
    .content-area {
      padding: 20px 16px;
      max-width: 600px;
      margin: 0 auto;
    }

    /* è¨‚å–®å¡ç‰‡ */
    .order-card {
      background: var(--gradient-card);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-card);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      animation: slideUp 0.4s ease backwards;
    }

    .order-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-accent);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-number {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-badge {
      background: var(--accent);
      color: var(--bg-primary);
      font-size: 12px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 20px;
    }

    .card-label {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .btn-delete-card {
      background: rgba(255, 71, 87, 0.1);
      color: var(--danger);
      border: 1px solid rgba(255, 71, 87, 0.3);
      padding: 8px 14px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .btn-delete-card:hover {
      background: rgba(255, 71, 87, 0.2);
    }

    /* è¼¸å…¥æ¡†ç¾¤çµ„ */
    .input-group {
      margin-bottom: 16px;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    label {
      display: block;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    input {
      width: 100%;
      height: 52px;
      padding: 0 16px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 16px;
      font-weight: 500;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: all 0.2s ease;
      font-family: inherit;
    }

    input::placeholder {
      color: var(--text-muted);
    }

    input:focus {
      border-color: var(--accent);
      background: var(--bg-primary);
      outline: none;
      box-shadow: 0 0 0 4px var(--accent-glow);
    }

    input[type="number"] {
      -moz-appearance: textfield;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
    }

    /* åº•éƒ¨æ“ä½œåˆ— */
    .footer-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(18, 18, 26, 0.98);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 16px 20px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      z-index: 200;
    }

    .btn {
      flex: 1;
      padding: 16px 20px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-add {
      background: var(--bg-card);
      color: var(--accent);
      border: 2px solid var(--accent);
      flex: 0 0 60px;
    }

    .btn-add:hover {
      background: rgba(0, 212, 170, 0.1);
    }

    .btn-send {
      background: var(--gradient-accent);
      color: var(--bg-primary);
      position: relative;
      overflow: hidden;
    }

    .btn-send::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: 0.5s;
    }

    .btn-send:hover::before {
      left: 100%;
    }

    .btn-send:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* æ­·å²ç´€éŒ„å¡ç‰‡ */
    .history-card {
      background: var(--gradient-card);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-card);
      border: 1px solid var(--border);
      animation: slideUp 0.4s ease backwards;
      position: relative;
      overflow: hidden;
    }

    .history-card.editable::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-accent);
    }

    .history-card.expired::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--danger);
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .history-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .history-time {
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .history-id {
      font-size: 12px;
      color: var(--text-muted);
      font-family: 'SF Mono', 'Fira Code', monospace;
    }

    .history-status {
      font-size: 12px;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 20px;
    }

    .status-active {
      background: rgba(0, 212, 170, 0.15);
      color: var(--accent);
    }

    .status-expired {
      background: rgba(255, 71, 87, 0.15);
      color: var(--danger);
    }

    .history-content {
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      padding: 16px;
      margin-bottom: 16px;
    }

    .order-item {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr;
      gap: 8px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }

    .order-item:last-child {
      border-bottom: none;
    }

    .order-item-label {
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .order-item-value {
      color: var(--text-primary);
      font-weight: 500;
    }

    .history-actions {
      display: flex;
      gap: 10px;
    }

    .btn-action {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-action:active {
      transform: scale(0.97);
    }

    .btn-edit {
      background: rgba(255, 165, 2, 0.15);
      color: var(--warning);
      border: 1px solid rgba(255, 165, 2, 0.3);
    }

    .btn-edit:hover {
      background: rgba(255, 165, 2, 0.25);
    }

    .btn-del {
      background: rgba(255, 71, 87, 0.15);
      color: var(--danger);
      border: 1px solid rgba(255, 71, 87, 0.3);
    }

    .btn-del:hover {
      background: rgba(255, 71, 87, 0.25);
    }

    .btn-refresh {
      width: 100%;
      margin-top: 20px;
      padding: 16px;
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-refresh:hover {
      background: var(--bg-card-hover);
      border-color: var(--accent);
    }

    .btn-refresh:active {
      transform: scale(0.98);
    }

    /* ç©ºç‹€æ…‹ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .empty-desc {
      font-size: 14px;
      color: var(--text-muted);
    }

    /* è¼‰å…¥é®ç½© */
    #loading-mask {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-primary);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 24px;
    }

    .loader {
      width: 60px;
      height: 60px;
      position: relative;
    }

    .loader::before,
    .loader::after {
      content: '';
      position: absolute;
      border-radius: 50%;
    }

    .loader::before {
      width: 100%;
      height: 100%;
      border: 3px solid var(--border);
    }

    .loader::after {
      width: 100%;
      height: 100%;
      border: 3px solid transparent;
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #loading-text {
      font-size: 16px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    #gate-btn {
      margin-top: 12px;
      padding: 14px 40px;
      background: var(--gradient-accent);
      color: var(--bg-primary);
      border: none;
      border-radius: 30px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      display: none;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    #gate-btn:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-glow);
    }

    /* éª¨æ¶å± */
    .skeleton {
      background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-card-hover) 50%, var(--bg-card) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-sm);
    }

    .skeleton-card {
      background: var(--gradient-card);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
    }

    .skeleton-line {
      height: 16px;
      margin-bottom: 12px;
    }

    .skeleton-line.short {
      width: 60%;
    }

    .skeleton-line.medium {
      width: 80%;
    }

    .skeleton-box {
      height: 100px;
      margin-bottom: 12px;
    }

    /* Toast é€šçŸ¥ */
    .toast {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 14px 24px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-card);
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.success {
      border-color: var(--accent);
    }

    .toast.error {
      border-color: var(--danger);
    }

    /* å€’æ•¸è¨ˆæ™‚ */
    .countdown {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: var(--warning);
      font-weight: 600;
    }

    .countdown-dot {
      width: 6px;
      height: 6px;
      background: var(--warning);
      border-radius: 50%;
      animation: pulse 1s infinite;
    }

    /* ç¢ºèªå°è©±æ¡† */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 28px;
      margin: 20px;
      max-width: 360px;
      width: 100%;
      border: 1px solid var(--border);
      transform: scale(0.9);
      transition: all 0.3s ease;
    }

    .modal-overlay.show .modal {
      transform: scale(1);
    }

    .modal-icon {
      width: 56px;
      height: 56px;
      margin: 0 auto 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }

    .modal-icon.warning {
      background: rgba(255, 71, 87, 0.15);
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 12px;
    }

    .modal-desc {
      font-size: 14px;
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
    }

    .modal-btn {
      flex: 1;
      padding: 14px;
      border-radius: var(--radius-sm);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .modal-btn-cancel {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .modal-btn-confirm {
      background: var(--danger);
      color: white;
    }
  </style>
</head>
<body>

  <!-- è¼‰å…¥é®ç½© -->
  <div id="loading-mask">
    <div class="loader"></div>
    <div id="loading-text">ç³»çµ±é€£ç·šä¸­...</div>
    <button id="gate-btn" onclick="liff.login({scope:'profile chat_message.write'})">ç™»å…¥ LINE</button>
  </div>

  <!-- Toast é€šçŸ¥ -->
  <div id="toast" class="toast"></div>

  <!-- ç¢ºèªå°è©±æ¡† -->
  <div id="modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-icon warning">âš ï¸</div>
      <div class="modal-title" id="modal-title">ç¢ºèªåˆªé™¤</div>
      <div class="modal-desc" id="modal-desc">ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="hideModal()">å–æ¶ˆ</button>
        <button class="modal-btn modal-btn-confirm" id="modal-confirm">ç¢ºèªåˆªé™¤</button>
      </div>
    </div>
  </div>

  <!-- æ–°å¢è¨‚å–®é é¢ -->
  <div id="view-form" class="view-section">
    <div class="header">
      <div class="header-title">
        <div class="header-icon">ğŸ“</div>
        <h2 id="form-title"><span>æ–°å¢</span>è¨‚å–®</h2>
      </div>
      <button class="btn-nav" onclick="showHistoryView()">
        <span>ğŸ“‹</span> æŸ¥çœ‹ç´€éŒ„
      </button>
    </div>
    <div class="content-area">
      <div id="order-list"></div>
    </div>
    <div class="footer-actions">
      <button class="btn btn-add" onclick="addItem()">ï¼‹</button>
      <button class="btn btn-send" id="btn-submit" onclick="submitOrder()">
        <span>âœ“</span> ç¢ºèªé€å‡º
      </button>
    </div>
  </div>

  <!-- æ­·å²ç´€éŒ„é é¢ -->
  <div id="view-history" class="view-section">
    <div class="header">
      <div class="header-title">
        <div class="header-icon">ğŸ“‹</div>
        <h2><span>å¾…è™•ç†</span>è¨‚å–®</h2>
      </div>
      <button class="btn-nav" onclick="showFormView()">
        <span>â•</span> æˆ‘è¦ä¸‹å–®
      </button>
    </div>
    <div class="content-area">
      <div id="history-container"></div>
      <button class="btn-refresh" onclick="fetchHistory()">
        <span>ğŸ”„</span> é‡æ–°æ•´ç†
      </button>
    </div>
  </div>

  <script>
    // âš ï¸ è¨­å®šå€
    const LIFF_ID = '2008839956-KquncO8W'; 
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxSxQMULkJwhjldW0eMWUbesEjxy3Kg0rYQpG7RJufIhzQMtvA9ZlenyEbaQBFkgW52mw/exec';

    let currentOrderId = null;
    let pendingDeleteId = null;
    let countdownIntervals = {};

    // ===== åˆå§‹åŒ– =====
    window.onload = function() {
      liff.init({ liffId: LIFF_ID }).then(() => {
        if (!liff.isLoggedIn()) {
          document.getElementById('loading-text').innerText = "è«‹å…ˆç™»å…¥ LINE";
          document.getElementById('gate-btn').style.display = 'block';
        } else {
          checkRoute();
        }
      }).catch(err => showToast("åˆå§‹åŒ–å¤±æ•—: " + err, 'error'));
    };

    function checkRoute() {
      const params = new URLSearchParams(window.location.search);
      const page = params.get('page');
      document.getElementById('loading-mask').style.display = 'none';
      if (page === 'history') showHistoryView();
      else showFormView();
    }

    // ===== é é¢åˆ‡æ› =====
    function showFormView() {
      document.getElementById('view-form').classList.add('active-view');
      document.getElementById('view-history').classList.remove('active-view');
      if(document.getElementById('order-list').innerHTML === '') addItem();
      
      const title = document.getElementById('form-title');
      if(currentOrderId) {
        title.innerHTML = '<span>ä¿®æ”¹</span>è¨‚å–®';
      } else {
        title.innerHTML = '<span>æ–°å¢</span>è¨‚å–®';
      }
    }

    function showHistoryView() {
      document.getElementById('view-form').classList.remove('active-view');
      document.getElementById('view-history').classList.add('active-view');
      fetchHistory();
    }

    // ===== API å‘¼å« =====
    function callApi(data, callback) {
      showLoading("è™•ç†ä¸­...");
      
      fetch(GAS_URL, { 
        method: 'POST', 
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(json => {
        hideLoading();
        callback(json);
      })
      .catch(err => {
        hideLoading();
        showToast("é€£ç·šéŒ¯èª¤: " + err, 'error');
      });
    }

    // ===== è¼‰å…¥ç‹€æ…‹ =====
    function showLoading(text) {
      const mask = document.getElementById('loading-mask');
      const loadingText = document.getElementById('loading-text');
      loadingText.innerText = text || "è™•ç†ä¸­...";
      document.getElementById('gate-btn').style.display = 'none';
      mask.style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loading-mask').style.display = 'none';
    }

    // ===== Toast é€šçŸ¥ =====
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const icon = type === 'success' ? 'âœ“' : 'âœ•';
      toast.innerHTML = `<span>${icon}</span> ${message}`;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ===== Modal å°è©±æ¡† =====
    function showModal(title, desc, onConfirm) {
      document.getElementById('modal-title').innerText = title;
      document.getElementById('modal-desc').innerText = desc;
      document.getElementById('modal-confirm').onclick = onConfirm;
      document.getElementById('modal').classList.add('show');
    }

    function hideModal() {
      document.getElementById('modal').classList.remove('show');
    }

    // ===== å–å¾—æ­·å²è¨‚å–® =====
    function fetchHistory() {
      const context = liff.getContext();
      if (!context || !context.userId) return;
      
      const userId = context.userId;
      const container = document.getElementById('history-container');
      
      // é¡¯ç¤ºéª¨æ¶å±
      container.innerHTML = `
        <div class="skeleton-card">
          <div class="skeleton skeleton-line short"></div>
          <div class="skeleton skeleton-box"></div>
          <div class="skeleton skeleton-line medium"></div>
        </div>
        <div class="skeleton-card">
          <div class="skeleton skeleton-line short"></div>
          <div class="skeleton skeleton-box"></div>
          <div class="skeleton skeleton-line medium"></div>
        </div>
      `;

      // æ¸…é™¤æ‰€æœ‰å€’æ•¸è¨ˆæ™‚
      Object.keys(countdownIntervals).forEach(key => {
        clearInterval(countdownIntervals[key]);
      });
      countdownIntervals = {};

      callApi({ action: 'getOrders', userId: userId }, (resp) => {
        container.innerHTML = '';

        if (!resp.orders || resp.orders.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">ğŸ“¦</div>
              <div class="empty-title">ç›®å‰æ²’æœ‰å¾…è™•ç†è¨‚å–®</div>
              <div class="empty-desc">é»æ“Šã€Œæˆ‘è¦ä¸‹å–®ã€é–‹å§‹å»ºç«‹æ–°è¨‚å–®</div>
            </div>
          `;
          return;
        }

        resp.orders.forEach((order, index) => {
          const div = document.createElement('div');
          const isEditable = order.remaining > 0;
          div.className = `history-card ${isEditable ? 'editable' : 'expired'}`;
          div.style.animationDelay = `${index * 0.1}s`;
          
          // è§£æè¨‚å–®å…§å®¹
          const items = parseOrderContent(order.content);
          let itemsHtml = items.map(item => `
            <div class="order-item">
              <div>
                <div class="order-item-label">å‹è™Ÿ</div>
                <div class="order-item-value">${escapeHtml(item.model)}</div>
              </div>
              <div>
                <div class="order-item-label">å°ºå¯¸</div>
                <div class="order-item-value">${escapeHtml(item.size)}</div>
              </div>
              <div>
                <div class="order-item-label">æ•¸é‡</div>
                <div class="order-item-value">${escapeHtml(item.qty)}</div>
              </div>
              <div>
                <div class="order-item-label">é¡è‰²</div>
                <div class="order-item-value">${escapeHtml(item.color) || '-'}</div>
              </div>
            </div>
          `).join('');

          let statusHtml = '';
          let actionsHtml = '';
          
          if (isEditable) {
            statusHtml = `
              <div class="history-status status-active">
                <span class="countdown" id="countdown-${order.orderId}">
                  <span class="countdown-dot"></span>
                  å‰©é¤˜ ${formatTime(order.remaining)}
                </span>
              </div>
            `;
            actionsHtml = `
              <div class="history-actions">
                <button class="btn-action btn-edit" onclick="loadEdit('${order.orderId}', '${encodeURIComponent(order.content)}')">
                  âœï¸ ä¿®æ”¹
                </button>
                <button class="btn-action btn-del" onclick="confirmDelete('${order.orderId}')">
                  ğŸ—‘ï¸ åˆªé™¤
                </button>
              </div>
            `;
            
            // å•Ÿå‹•å€’æ•¸è¨ˆæ™‚
            startCountdown(order.orderId, order.remaining);
          } else {
            statusHtml = `<div class="history-status status-expired">å·²é€¾æ™‚</div>`;
            actionsHtml = `<div style="text-align:center; color:var(--text-muted); font-size:13px; padding:10px;">å·²è¶…éä¿®æ”¹æ™‚é™</div>`;
          }

          div.innerHTML = `
            <div class="history-header">
              <div class="history-meta">
                <div class="history-time">ğŸ“… ${order.time}</div>
                <div class="history-id">${order.orderId}</div>
              </div>
              ${statusHtml}
            </div>
            <div class="history-content">${itemsHtml}</div>
            ${actionsHtml}
          `;
          
          container.appendChild(div);
        });
      });
    }

    // ===== å€’æ•¸è¨ˆæ™‚ =====
    function startCountdown(orderId, seconds) {
      let remaining = seconds;
      
      countdownIntervals[orderId] = setInterval(() => {
        remaining--;
        const el = document.getElementById(`countdown-${orderId}`);
        
        if (remaining <= 0) {
          clearInterval(countdownIntervals[orderId]);
          if (el) {
            el.parentElement.className = 'history-status status-expired';
            el.parentElement.innerHTML = 'å·²é€¾æ™‚';
          }
          return;
        }
        
        if (el) {
          el.innerHTML = `<span class="countdown-dot"></span> å‰©é¤˜ ${formatTime(remaining)}`;
        }
      }, 1000);
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    // ===== è¼‰å…¥ç·¨è¼¯ =====
    function loadEdit(orderId, contentEncoded) {
      currentOrderId = orderId;
      const content = decodeURIComponent(contentEncoded);
      showFormView();
      
      const container = document.getElementById('order-list');
      container.innerHTML = '';
      
      const lines = content.split('\n');
      lines.forEach(line => {
        const parts = line.split(',');
        if(parts.length >= 3) {
          addItem(parts[0].trim(), parts[1].trim(), parts[2].trim(), parts[3] ? parts[3].trim() : '');
        }
      });
    }

    // ===== åˆªé™¤è¨‚å–® =====
    function confirmDelete(orderId) {
      pendingDeleteId = orderId;
      showModal(
        'ç¢ºèªåˆªé™¤è¨‚å–®',
        'åˆªé™¤å¾Œå°‡ç„¡æ³•æ¢å¾©ï¼Œç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ',
        executeDelete
      );
    }

    function executeDelete() {
      hideModal();
      if (!pendingDeleteId) return;
      
      callApi({ action: 'delete', orderId: pendingDeleteId }, (resp) => {
        if(resp.result === 'success') {
          showToast("è¨‚å–®å·²æˆåŠŸåˆªé™¤", 'success');
          fetchHistory();
        } else {
          showToast("åˆªé™¤å¤±æ•—: " + resp.msg, 'error');
        }
        pendingDeleteId = null;
      });
    }

    // ===== é€å‡ºè¨‚å–® =====
    function submitOrder() {
      const cards = document.querySelectorAll('.card-item');
      let lines = [];
      
      cards.forEach(card => {
        const m = card.querySelector('.in-model').value.trim();
        const s = card.querySelector('.in-size').value.trim();
        const q = card.querySelector('.in-qty').value.trim();
        const c = card.querySelector('.in-color').value.trim();
        if(m && q) lines.push(`${m}, ${s}, ${q}, ${c}`);
      });

      if(lines.length === 0) {
        showToast("è«‹å¡«å¯«ã€Œå‹è™Ÿã€èˆ‡ã€Œæ•¸é‡ã€", 'error');
        return;
      }

      const action = currentOrderId ? 'update' : 'create';
      
      const context = liff.getContext();
      if (!context || !context.userId) {
        showToast("ç„¡æ³•å–å¾—ä½¿ç”¨è€… IDï¼Œè«‹é‡æ–°ç™»å…¥", 'error');
        setTimeout(() => location.reload(), 2000);
        return;
      }

      const userId = context.userId;

      callApi({
        action: action,
        orderId: currentOrderId,
        userId: userId,
        content: lines.join('\n')
      }, (resp) => {
        if(resp.result === 'success') {
          showToast(action === 'create' ? "è¨‚å–®å·²æˆåŠŸé€å‡ºï¼" : "è¨‚å–®ä¿®æ”¹æˆåŠŸï¼", 'success');
          currentOrderId = null;
          document.getElementById('order-list').innerHTML = '';
          addItem();
          showHistoryView();
        } else {
          showToast("æ“ä½œå¤±æ•—: " + resp.msg, 'error');
        }
      });
    }

    // ===== æ–°å¢é …ç›® =====
    function addItem(m='', s='', q='', c='') {
      const container = document.getElementById('order-list');
      const count = container.children.length + 1;
      const div = document.createElement('div');
      div.className = 'order-card card-item';
      div.style.animationDelay = `${(count - 1) * 0.1}s`;
      
      div.innerHTML = `
        <div class="card-header">
          <div class="card-number">
            <span class="card-badge">${count}</span>
            <span class="card-label">å•†å“é …ç›®</span>
          </div>
          ${count > 1 ? '<button class="btn-delete-card" onclick="removeCard(this)">ç§»é™¤</button>' : ''}
        </div>
        <div class="input-group">
          <label>å‹è™Ÿ *</label>
          <input type="text" class="in-model" value="${escapeHtml(m)}" placeholder="è¼¸å…¥ç”¢å“å‹è™Ÿ">
        </div>
        <div class="input-row">
          <div class="input-group">
            <label>å°ºå¯¸</label>
            <input type="text" class="in-size" value="${escapeHtml(s)}" placeholder="å°ºå¯¸">
          </div>
          <div class="input-group">
            <label>æ•¸é‡ *</label>
            <input type="number" class="in-qty" value="${escapeHtml(q)}" placeholder="æ•¸é‡" min="1">
          </div>
        </div>
        <div class="input-group">
          <label>é¡è‰²</label>
          <input type="text" class="in-color" value="${escapeHtml(c)}" placeholder="é¡è‰²ï¼ˆé¸å¡«ï¼‰">
        </div>
      `;
      
      container.appendChild(div);
      
      setTimeout(() => {
        div.scrollIntoView({ behavior: 'smooth', block: 'center' });
        div.querySelector('.in-model').focus();
      }, 100);
    }

    function removeCard(btn) {
      const card = btn.closest('.card-item');
      card.style.animation = 'fadeIn 0.3s ease reverse';
      setTimeout(() => {
        card.remove();
        updateCardNumbers();
      }, 300);
    }

    function updateCardNumbers() {
      const cards = document.querySelectorAll('.card-item');
      cards.forEach((card, index) => {
        const badge = card.querySelector('.card-badge');
        if (badge) badge.innerText = index + 1;
        
        // æ›´æ–°åˆªé™¤æŒ‰éˆ•
        const header = card.querySelector('.card-header');
        const existingBtn = header.querySelector('.btn-delete-card');
        
        if (index === 0 && existingBtn) {
          existingBtn.remove();
        } else if (index > 0 && !existingBtn) {
          const btn = document.createElement('button');
          btn.className = 'btn-delete-card';
          btn.onclick = function() { removeCard(this); };
          btn.innerText = 'ç§»é™¤';
          header.appendChild(btn);
        }
      });
    }

    // ===== å·¥å…·å‡½æ•¸ =====
    function parseOrderContent(content) {
      return content.split('\n').map(line => {
        const parts = line.split(',');
        return {
          model: parts[0] ? parts[0].trim() : '',
          size: parts[1] ? parts[1].trim() : '',
          qty: parts[2] ? parts[2].trim() : '',
          color: parts[3] ? parts[3].trim() : ''
        };
      }).filter(item => item.model);
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
    }
  </script>
</body>
</html>